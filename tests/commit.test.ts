import { describe, expect, it, vi } from 'vitest'
import { failIfInfiniteLoopDetected } from '../src/commit.js'
import * as git from '../src/git.js'

vi.mock('../src/git')

describe('failIfInfiniteLoopDetected', () => {
  it('fails if the last commits are generated by this action', async () => {
    vi.mocked(git.getCommitMessages).mockResolvedValue([
      'Generated-by: update-generated-files-action',
      'Generated-by: update-generated-files-action',
      'Generated-by: update-generated-files-action',
      'Generated-by: update-generated-files-action',
      'Generated-by: update-generated-files-action',
    ])
    await expect(failIfInfiniteLoopDetected('sha')).rejects.toThrow(/infinite loop/)
  })
})
