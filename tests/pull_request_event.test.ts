import * as git from '../src/git'
import { handlePullRequestEvent } from '../src/pull_request_event'

jest.mock('@actions/core')
jest.mock('../src/git')

test('pull request event', async () => {
  await handlePullRequestEvent(
    {
      commitMessage: 'Generated by GitHub Actions (workflow / job)',
      commitMessageFooter: 'https://github.com/int128/update-generated-files-action/actions/runs/4309709120',
      title: 'Follow up the generated files',
      body: 'Body',
      token: 'GITHUB_TOKEN',
    },
    {
      ref: 'refs/pull/23/merge',
      sha: 'sha-merge-commit',
      payload: {
        action: 'dummy',
        pull_request: {
          base: {
            sha: 'sha-base',
          },
          head: {
            ref: 'topic',
            sha: 'sha-head',
          },
        },
      },
    }
  )

  expect(git.fetch).toHaveBeenCalledWith({
    ref: 'refs/pull/23/merge',
    token: 'GITHUB_TOKEN',
    depth: 2,
  })

  expect(git.commit).toHaveBeenCalledWith({
    ref: 'refs/heads/topic',
    token: 'GITHUB_TOKEN',
    commitMessage: `Generated by GitHub Actions (workflow / job)

https://github.com/int128/update-generated-files-action/actions/runs/4309709120`,
  })
})
